# En .github/workflows/backend-ci.yml (REEMPLAZAR TODO OTRA VEZ)

name: Backend CI - Docker Compose Tests

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v4

      - name: Levantar servicios con Docker Compose
        # Solo levantamos los servicios, sin preocuparnos por el .env
        run: docker compose up --build -d backend redis

      - name: Esperar a que los servicios estén listos
        run: sleep 15

      - name: Correr Tests dentro del contenedor del Backend
        # ¡VOLVEMOS A INYECTAR LAS VARIABLES ACÁ!
        # Es la forma más segura y explícita.
        run: >
          docker compose exec -T
          -e PYTHONUTF8="1"
          -e APP_ENV="test"
          -e FRONTEND_URL="http://localhost:3000"
          -e BACKEND_URL="http://test"
          -e REDIS_URL="redis://redis:6379"
          -e DB_SQL_URI="sqlite+aiosqlite:///:memory:"
          -e DB_NOSQL_URI="mongodb://localhost:27017/testdb"
          -e SECRET_KEY="clave-secreta-para-tests"
          -e ALGORITHM="HS256"
          -e ACCESS_TOKEN_EXPIRE_MINUTES="30"
          -e MERCADOPAGO_TOKEN="token-de-prueba"
          -e CLOUDINARY_CLOUD_NAME="test"
          -e CLOUDINARY_API_KEY="test"
          -e CLOUDINARY_API_SECRET="test"
          -e EMAIL_SENDER="test@example.com"
          -e EMAIL_APP_PASSWORD="test"
          -e SITE_NAME="Test"
          -e GROQ_API_KEY="gsk-test"
          -e GROQ_MODEL_NAME="test"
          backend
          python -m pytest